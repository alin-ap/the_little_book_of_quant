# 第 3 章：工程架构

## 1. 核心架构分层

一个成熟的量化系统通常由以下三层构成：

### 1.1 数据与特征层 (Input & Feature)

*   **显式因子**：传统量价、财报数据。
*   **隐式因子**：使用 Genetic Programming (遗传规划, 如 `gplearn`) 暴力挖掘数万个数学公式因子。
*   **去噪与中性化**：这是关键步骤！在入模前，对因子做正交化 (Orthogonalization)，剔除大盘（Beta）、行业、市值的影响。确保你赚的是纯 Alpha，而不是运气。

### 1.2 核心模型层 (The Hybrid Core) —— 混合专家系统

不再是单一模型，而是“三支柱”协同工作：

*   **支柱 A (基本面): LightGBM / CatBoost**
    *   **任务**: 处理低频、高噪的财务数据和分析师预期。
*   **支柱 B (时序): PatchTST / Mamba**
    *   **任务**: 吃进原始高频量价序列，捕捉 K 线形态。
*   **支柱 C (关联): GNN (GAT)**
    *   **任务**: 输入行业关系图，修正个股打分（逻辑：“大家都涨了，你还没涨，那你该补涨了”）。

### 1.3 组合优化层 (Portfolio Optimization)

不再是简单的“买 Top 10”。

*   **输入**：模型预测的收益 + GARCH 预测的波动率 + Barra 风险模型。
*   **算法**：Mean-Variance Optimization (均值方差优化)。求解出在风险可控前提下的最优仓位权重。

## 2. 代码实现最佳实践

### 模块化设计
- 数据、因子、回测、评估模块分离
- 接口一致性

### 性能优化
- 向量化计算 (Vectorization)
- 并行处理 (Multiprocessing)
- 缓存中间结果 (Caching)
- 减少循环中的数据重组

### 健壮性保证
- 异常处理
- 边界条件测试
- 单元测试覆盖

### 可重复性
- 固定随机种子 (Random Seed)
- 版本控制 (Git)
- 参数配置化 (Config)
- 结果序列化
